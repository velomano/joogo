# 작업 로그 - 2025년 1월 9일

## 완료된 작업

### 1. RPC 함수 파라미터 타입 수정
- **문제**: RPC 함수들이 `date` 타입 파라미터를 사용하여 API에서 호출 시 데이터를 찾지 못함
- **해결**: 모든 RPC 함수의 날짜 파라미터를 `text`로 변경하고 `::date` 캐스팅 추가
- **영향받은 함수들**:
  - `board_sales_daily`
  - `board_top_categories`
  - `board_top_regions`
  - `board_top_skus`
  - `board_abc_by_sku`
  - `board_roas_by_channel`

### 2. RPC 함수 오류 수정
- **문제**: `board_roas_by_channel` 함수에서 존재하지 않는 `f.spend` 컬럼 참조
- **해결**: `spend` 컬럼을 0으로 설정하고 `roas`도 0으로 반환하도록 수정

### 3. API 엔드포인트 디버깅 강화
- **파일**: `apps/web-admin/src/app/api/board/charts/route.ts`
- **추가**: RPC 호출 파라미터와 응답에 대한 상세한 로깅
- **목적**: 데이터가 존재하지만 API에서 빈 배열을 반환하는 문제 디버깅

### 4. 파일 업로드 시스템 개선
- **파일**: `apps/web-admin/src/components/FileUpload.tsx`
- **개선사항**:
  - CSV 파싱 로직 강화 (BOM 제거, 헤더 정규화)
  - `on_hand` 필드 매핑 추가 (`stock_on_hand`, `inventory`, `stock` 등)
  - 업로드 버튼 UI 개선
  - 에러 처리 강화

### 5. 대시보드 통합
- **파일**: `apps/web-admin/src/app/board/page.tsx`
- **변경사항**:
  - 모든 차트 데이터를 `/api/board/charts` 엔드포인트로 통합
  - 개별 `useRpc` 호출을 `useSWR`로 대체
  - 날짜 범위 기본값을 `1year`로 설정
  - 필드명 수정 (`sale_date` → `date`, `tavg` → `temp`)

## 현재 상태

### 데이터 현황
- ✅ **데이터 존재**: 21,778개 행이 `analytics.fact_sales`에 저장됨
- ✅ **직접 SQL 작동**: RPC 함수들이 Supabase Studio에서 정상 작동
- ❌ **API 호출 실패**: 여전히 RPC 함수들이 API에서 빈 배열 반환

### 남은 문제
1. **RPC 함수 호출 실패**: 데이터는 있지만 API에서 `dataLength: 0` 반환
2. **권한 오류**: `permission denied for table tenants` 지속 발생
3. **캐시 문제**: 데이터 리셋 후에도 이전 데이터가 표시되는 경우

## 다음 단계

1. **RPC 함수 시그니처 확인**: PostgREST 스키마 캐시 리로드 필요
2. **권한 문제 해결**: `tenants` 테이블 접근 권한 설정
3. **캐시 무효화**: SWR 캐시 및 PostgREST 캐시 정리

## 커밋 정보
- **브랜치**: `fix/remove-sample-data`
- **커밋 해시**: `8a104b8`
- **변경된 파일**: 3개
- **추가된 라인**: 19줄
- **삭제된 라인**: 3줄


