# 작업 로그 - 2025년 1월 6일

## 완료된 작업

### 1. 워커 시스템 구현
- ✅ `apps/ingest-worker` 디렉토리 구조 생성
- ✅ CSV 파일 파싱 및 헤더 매핑 로직 구현
- ✅ Supabase Storage에서 파일 다운로드 기능
- ✅ `analytics.stage_sales` 테이블에 데이터 스테이징
- ✅ `public.board_merge_file` 함수를 통한 `analytics.fact_sales` 머지
- ✅ 실시간 데이터 버전 업데이트 (`analytics.bump_data_version`)

### 2. 데이터베이스 스키마 수정
- ✅ `analytics.stage_sales` 테이블 생성 (cost, tavg 컬럼 추가)
- ✅ `analytics.fact_sales` 테이블 생성 (is_event 컬럼 추가)
- ✅ `public.tenants` 테이블 생성
- ✅ `public.raw_uploads` 테이블 생성
- ✅ `public.board_merge_file` 함수 생성 (original_data jsonb 캐스팅 포함)
- ✅ `public.board_reset_tenant_data` 함수 생성

### 3. RPC 함수 정리
- ✅ `analytics.board_sales_daily` 함수 동적 생성 (컬럼 자동 감지)
- ✅ `public.board_sales_daily` 래퍼 함수들 생성
- ✅ `public.board_abc_by_sku`, `public.board_reorder_points`, `public.board_eol_candidates` 함수들 생성
- ✅ PostgREST 스키마 캐시 리로드

### 4. 웹 어드민 수정
- ✅ `apps/web-admin` Next.js 애플리케이션 구조
- ✅ 실시간 데이터 동기화 (`useDataVersion`, `IngestBridge`)
- ✅ CSV 파일 업로드 API (`/api/upload/unified`)
- ✅ 보드 데이터 조회 API들 (`/api/board/*`)

## 현재 문제점

### 1. RPC 함수 시그니처 불일치
**문제:** 프론트엔드가 `(p_from, p_tenant_id, p_to)` 형태로 RPC 호출하지만, 실제 함수는 `(p_from, p_to, p_region, p_channel, p_category, p_sku)` 형태

**에러 메시지:**
```
Could not find the function public.board_sales_daily(p_from, p_tenant_id, p_to) in the schema cache
```

**해결 필요:** 프론트엔드 RPC 호출 방식 수정 또는 RPC 함수 시그니처 추가

### 2. 데이터 저장 문제
**문제:** 워커가 파일을 처리했다고 로그에 표시되지만 `analytics.fact_sales` 테이블에 데이터가 0개

**원인 추정:**
- `board_merge_file` 함수 실행 중 에러 발생
- `stage_sales` → `fact_sales` 머지 과정에서 실패
- 데이터 타입 불일치 (original_data jsonb 캐스팅 문제)

### 3. Weather API 500 에러
**문제:** 기상청 API 호출 시 500 Internal Server Error
**영향:** 보드 페이지 로딩 시 불필요한 에러 발생

## 다음 작업 계획

### 1. RPC 함수 시그니처 통일
- 프론트엔드에서 올바른 파라미터 순서로 RPC 호출하도록 수정
- 또는 RPC 함수에 `(p_from, p_tenant_id, p_to)` 시그니처 추가

### 2. 데이터 저장 문제 디버깅
- `board_merge_file` 함수 실행 로그 확인
- `stage_sales` 테이블 데이터 확인
- `original_data` jsonb 캐스팅 문제 해결

### 3. Weather API 에러 처리
- API 에러 핸들링 개선
- 또는 Weather API 호출 비활성화

## 기술적 세부사항

### 워커 아키텍처
```
CSV Upload → Supabase Storage → Worker Polling → 
CSV Parsing → Header Mapping → stage_sales → 
board_merge_file → fact_sales → bump_data_version
```

### 데이터 플로우
1. 사용자가 CSV 파일 업로드
2. 파일이 Supabase Storage `incoming` 버킷에 저장
3. 워커가 주기적으로 파일을 폴링
4. CSV 파싱 및 헤더 매핑
5. `analytics.stage_sales`에 데이터 스테이징
6. `public.board_merge_file` 함수로 `analytics.fact_sales`에 머지
7. `analytics.bump_data_version`으로 실시간 업데이트 신호

### 주요 파일들
- `apps/ingest-worker/src/index.ts` - 워커 메인 로직
- `apps/ingest-worker/src/mapping.ts` - CSV 헤더 매핑
- `apps/web-admin/src/app/board/page.tsx` - 보드 페이지
- `apps/web-admin/src/app/api/upload/unified/route.ts` - 업로드 API
- `supabase/migrations/` - 데이터베이스 스키마 변경사항
