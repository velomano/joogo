# 내일 할 일 – 실행 체크리스트 (2025-09-07)

## 1) PR 열기 (branch: fix/remove-sample-data → base: reset/mvp-board 혹은 main)

### PR 본문 템플릿
```markdown
## 목적
- 실시간 동기화 완성, 팝업 제거, 전역 상태/데이터 페칭 통일

## 변경 요약
- Realtime: data_version / ingest_jobs 구독 전역화
- RPC: public 래퍼 기반 통일 (board_sales_daily 등)
- 캐시: 모든 API no-store, useRpc + versionKey
- UI: 자동 새로고침, 팝업 제거

## 리스크/롤백
- RPC 시그니처 불일치 → public 래퍼로 고정
- Realtime 세션 미존재 시 DEV 폴백 사용
- 문제 시 폴링 모드(20s/3s)로 즉시 전환

## 체크리스트
- [ ] `public.board_sales_daily` 6-파라미터/0-인자 버전 존재
- [ ] `pg_notify('pgrst','reload schema')` 수행
- [ ] publication: data_version, ingest_jobs 등록 + replica identity full
- [ ] 전역 IngestBridge만 구독 (페이지별 구독 없음)
- [ ] Board/ABC/Inventory 모두 useRpc 사용
- [ ] 수동 `bump_data_version()` 시 화면 자동 갱신
```

## 2) "업로드 데이터 매핑 문제" 해결 (핵심 설계 + 바로 쓰는 스니펫)

### 2.1 DB 매핑 테이블 (헤더 표준화)
```sql
create schema if not exists analytics;

create table if not exists analytics.csv_header_map(
  tenant_id uuid not null,
  alias text not null,          -- 들어온 헤더(소문자/트림/언더스코어 처리 전)
  canonical text not null,      -- 표준 컬럼명 (date, region, channel, category, sku, qty, unit_price, discount_rate, unit_cost, revenue, tavg, spend, is_event 등)
  updated_at timestamptz default now(),
  primary key (tenant_id, alias)
);

-- 공통(글로벌) 기본 매핑: tenant_id = 00000000-0000-0000-0000-000000000000
insert into analytics.csv_header_map(tenant_id, alias, canonical)
values
  ('00000000-0000-0000-0000-000000000000','Date','date'),
  ('00000000-0000-0000-0000-000000000000','날짜','date'),
  ('00000000-0000-0000-0000-000000000000','지역','region'),
  ('00000000-0000-0000-0000-000000000000','판매수량','qty'),
  ('00000000-0000-0000-0000-000000000000','quantity','qty'),
  ('00000000-0000-0000-0000-000000000000','상품코드','sku'),
  ('00000000-0000-0000-0000-000000000000','단가','unit_price'),
  ('00000000-0000-0000-0000-000000000000','할인율','discount_rate'),
  ('00000000-0000-0000-0000-000000000000','원가','unit_cost'),
  ('00000000-0000-0000-0000-000000000000','매출','revenue'),
  ('00000000-0000-0000-0000-000000000000','평균기온','tavg'),
  ('00000000-0000-0000-0000-000000000000','광고비','spend')
on conflict do nothing;
```

### 2.2 워커: 표준화 파이프라인 (헤더 정규화 + 매핑 + 밸리데이션)
```typescript
// apps/ingest-worker/src/mapping.ts
const CANON = new Set([
  'date','region','channel','category','sku','qty',
  'unit_price','discount_rate','unit_cost','revenue',
  'tavg','spend','is_event'
]);

export function normalizeHeader(h: string){
  return h.normalize('NFKC').trim()
    .replace(/\s+/g,' ')
    .toLowerCase()
    .replace(/[^\w가-힣%/.-]/g,'_')        // 안전 치환
    .replace(/_+/g,'_')
    .replace(/^_|_$/g,'');
}

export async function buildHeaderMap(db, tenantId: string, rawHeaders: string[]) {
  // 1) 정규화
  const norm = rawHeaders.map(normalizeHeader);

  // 2) DB 매핑 조회 (tenant 우선 → 글로벌)
  const { data: rows } = await db
    .from('csv_header_map')
    .select('alias, canonical')
    .in('alias', rawHeaders)   // 원본 alias로 먼저 시도
    .eq('tenant_id', tenantId);

  const { data: globalRows } = await db
    .from('csv_header_map')
    .select('alias, canonical')
    .in('alias', rawHeaders)
    .eq('tenant_id', '00000000-0000-0000-0000-000000000000');

  const dbMap = new Map<string,string>([
    ...rows?.map(r=>[normalizeHeader(r.alias), r.canonical]) ?? [],
    ...globalRows?.map(r=>[normalizeHeader(r.alias), r.canonical]) ?? [],
  ]);

  // 3) 휴리스틱 기본 매핑
  const heuristic = (n: string): string|undefined => {
    if (['date','날짜'].some(k=>n.includes(k))) return 'date';
    if (['region','지역'].some(k=>n.includes(k))) return 'region';
    if (['channel','채널'].some(k=>n.includes(k))) return 'channel';
    if (['category','카테고리'].some(k=>n.includes(k))) return 'category';
    if (['sku','상품','코드'].some(k=>n.includes(k))) return 'sku';
    if (['qty','수량','quantity'].some(k=>n.includes(k))) return 'qty';
    if (['단가','unit_price','가격'].some(k=>n.includes(k))) return 'unit_price';
    if (['할인','discount'].some(k=>n.includes(k))) return 'discount_rate';
    if (['원가','cost'].some(k=>n.includes(k))) return 'unit_cost';
    if (['revenue','매출','금액'].some(k=>n.includes(k))) return 'revenue';
    if (['tavg','평균기온','기온'].some(k=>n.includes(k))) return 'tavg';
    if (['spend','광고비'].some(k=>n.includes(k))) return 'spend';
    if (['event','is_event'].some(k=>n.includes(k))) return 'is_event';
    return undefined;
  };

  // 4) 최종 매핑
  const final = norm.map(n => dbMap.get(n) ?? heuristic(n) ?? n);
  // 5) 표준 스키마에 없는 컬럼은 통과(보존), 필요 필수만 검사
  const required = ['date','region','channel','sku','qty'];
  const hasRequired = required.every(r => final.includes(r));
  return { finalHeaders: final, hasRequired };
}

// 숫자/날짜 파서(워커 공통 util)
export function toNum(v:any){ if(v===''||v==null) return undefined;
  const s=String(v).replace(/,/g,'');
  const n=Number(s); return Number.isFinite(n)?n:undefined;
}
export function toDateISO(v:any){
  const s=String(v).trim().replace(/[./]/g,'-');
  const d=new Date(s); return isNaN(d.getTime())? null : d.toISOString().slice(0,10);
}
```

### 적용 포인트
- 스테이징 시 컬럼 rename(매핑 결과 finalHeaders)로 표준 컬럼으로 맞춘 후 COPY/INSERT
- revenue 없으면 qty*unit_price*(1-discount_rate) 보완
- 머지 끝에서 bump_data_version(tenant) 호출

### 2.3 스모크(로컬 2분)
- CSV 업로드 → 워커 로그에 hasRequired=true
- `select analytics.bump_data_version('<tenant>');` → 보드/ABC/재고 자동 갱신
- `POST /rest/v1/rpc/board_sales_daily` 200 확인

## 3) RPC & Realtime 최종 점검(10줄)
```sql
-- public 래퍼 존재
select routine_schema, routine_name
from information_schema.routines
where routine_schema='public' and routine_name='board_sales_daily';

-- 파라미터 이름 일치
select oid::regprocedure::text, proargnames
from pg_proc p join pg_namespace n on n.oid=p.pronamespace
where n.nspname='public' and p.proname='board_sales_daily';

-- publication + replica identity
select schemaname, tablename from pg_publication_tables where pubname='supabase_realtime';
select relname, relreplident
from pg_class c join pg_namespace n on n.oid=c.relnamespace
where n.nspname='analytics' and relname in ('data_version','ingest_jobs');

-- bump 시그널
select analytics.bump_data_version('00000000-0000-0000-0000-000000000001');
```

## 4) Definition of Done (내일)
- [ ] 샘플 CSV 2종(한글 헤더/영문 헤더) 업로드 시 모두 정상 매핑
- [ ] 업로드 완료 후 1–2초 내 세 페이지(보드/ABC/재고) 동시 갱신
- [ ] `public.board_sales_daily` RPC 200, 데이터 > 0
- [ ] 워커 로그에 hasRequired=true, 누락 시 명확한 에러 메시지
- [ ] PR 머지 후 Cloudflare 프리뷰 확인
