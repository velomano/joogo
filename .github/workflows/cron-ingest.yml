name: Cron Data Ingest

on:
  schedule:
    # λ§¤μ‹κ°„ μ •κ°μ— μ‹¤ν–‰
    - cron: '0 * * * *'
  workflow_dispatch: # μλ™ μ‹¤ν–‰ κ°€λ¥
    inputs:
      force_run:
        description: 'Force run even if data exists'
        required: false
        default: 'false'
        type: boolean

jobs:
  ingest:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9
          
      - name: Install dependencies
        run: |
          corepack enable
          corepack prepare pnpm@9 --activate
          pnpm -w install --no-frozen-lockfile
          
      - name: Check if data exists (optional)
        if: ${{ !inputs.force_run }}
        run: |
          echo "Checking if data already exists..."
          # μ—¬κΈ°μ„ DBμ— λ°μ΄ν„°κ°€ μλ”μ§€ ν™•μΈν•λ” λ΅μ§ μ¶”κ°€ κ°€λ¥
          
      - name: Run cron job
        run: |
          cd apps/ingest-worker
          echo "π€ Starting cron job..."
          echo "β° Job started at: $(date)"
          echo "π“ Environment check:"
          echo "  - SUPABASE_URL: ${SUPABASE_URL:0:20}..."
          echo "  - SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY:0:20}..."
          
          pnpm run cron:dev
          
          echo "β… Cron job completed"
          echo "β° Job finished at: $(date)"
          echo "π“ Data ingestion summary:"
          echo "  - Sales data: Updated"
          echo "  - Weather data: Updated" 
          echo "  - Ads data: Updated"
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
          REPO_NAME: ${{ secrets.REPO_NAME }}
          
      - name: Notify completion
        if: always()
        run: |
          echo "π“ Cron job completed with status: ${{ job.status }}"
          echo "β° Completed at: $(date)"
